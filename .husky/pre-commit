echo "[ğŸ¶ Husky] Running pre-commit hook..."

# Get current branch
current_branch=$(git rev-parse --abbrev-ref HEAD)

# Skip checks if on main branch
if [ "$current_branch" = "main" ]; then
    echo "âœ… On main branch, skipping update checks"
else
    echo "ğŸ” Checking for branch updates..."

    # Fetch latest changes
    git fetch origin

    # Check updates from main
    behind_commits=$(git rev-list --count $current_branch..origin/main)
    if [ "$behind_commits" -gt 0 ]; then
        echo "âš ï¸ Main branch has $behind_commits new commits!"
        echo "ğŸ’¡ Run: git pull origin main"
        exit 1
    fi
    echo "âœ… Branch is up to date with main"

    # Check remote branch updates
    if git ls-remote --heads origin $current_branch | grep -q $current_branch; then
        remote_commits=$(git rev-list --count $current_branch..origin/$current_branch 2>/dev/null)
        if [ "$remote_commits" -gt 0 ]; then
            echo "âš ï¸ Remote branch has $remote_commits new commits!"
            echo "ğŸ’¡ Run: git pull origin $current_branch"
            exit 1
        fi
        echo "âœ… Branch is up to date with remote"
    else
        echo "â„¹ï¸ No remote branch found (new branch)"
    fi
fi

# Run sync script and handle changes
echo "ğŸ”„ Running sync script..."
yarn build

if [ $? -eq 0 ]; then
    if [ -n "$(git status --porcelain)" ]; then
        echo "ğŸ“ Changes detected, adding to commit..."
        git add .
    else
        echo "âœ… No changes to sync"
    fi
else
    echo "âŒ Sync script failed"
    exit 1
fi

# Run husky pre-commit script if exists
if yarn run --list 2>/dev/null | grep -q "husky:pre-commit"; then
    echo "ğŸ” Running pre-commit checks..."
    yarn husky:pre-commit
else
    echo "â„¹ï¸ No husky:pre-commit script found"
fi

echo "[ğŸ¶ Husky] Done âœ…"
exit 0
